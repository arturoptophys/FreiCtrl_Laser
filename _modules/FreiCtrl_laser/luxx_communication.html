<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FreiCtrl_laser.luxx_communication &#8212; FreiCtrl_laser 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css?v=7610408e" />
    <script src="../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">FreiCtrl_laser 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">FreiCtrl_laser.luxx_communication</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for FreiCtrl_laser.luxx_communication</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module uses **pyserial** module for communication with OMICRON LuxX</span>
<span class="sd">laser. The class **Laser** provides convenient methods for control of one</span>
<span class="sd">or several lasers, connected to the computer.</span>

<span class="sd">Example</span>
<span class="sd">-------</span>
<span class="sd">laser1 = Laser()</span>
<span class="sd">laser1.smart_ask(&quot;GSI&quot;)</span>
<span class="sd">laser1.smart_ask(&quot;GOM&quot;)</span>
<span class="sd">laser1.start()</span>
<span class="sd">laser1.set_power(24)</span>
<span class="sd">laser1.stop()</span>
<span class="sd">del laser1</span>

<span class="sd">Author</span>
<span class="sd">------</span>
<span class="sd">Roman Kiselev, January 2014</span>
<span class="sd">Artur Schneider, November 2023</span>
<span class="sd">- adopted to python3</span>

<span class="sd">License</span>
<span class="sd">-------</span>
<span class="sd">GNU GPL - use it for any purpose</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">serial</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">IntEnum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<div class="viewcode-block" id="Laser">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.Laser">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Laser</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class represents OMICRON LuxX laser. It opens the communication</span>
<span class="sd">    port upon object creation and asks the device for model and maximum</span>
<span class="sd">    power.</span>

<span class="sd">    Functions</span>
<span class="sd">    ---------</span>
<span class="sd">     * __init__(port=&quot;auto&quot;, baudrate=500000)</span>
<span class="sd">         constructor. Open port, get model name and power</span>
<span class="sd">     * __del__()</span>
<span class="sd">         destructor. Close the port upon completion</span>
<span class="sd">     * write(command)</span>
<span class="sd">         send command to device</span>
<span class="sd">     * read()</span>
<span class="sd">         read all data from port buffer</span>
<span class="sd">     * ask(command)</span>
<span class="sd">         send command and get only the relevant answer, as well as time</span>
<span class="sd">     * smart_ask(command)</span>
<span class="sd">         ask, which prints HEX answers in a table</span>
<span class="sd">     * print_HEX(HEXstring)</span>
<span class="sd">         print a nice table representing bits in a HEX number</span>
<span class="sd">     * start()</span>
<span class="sd">         start emission (takes 3 seconds)</span>
<span class="sd">     * stop()</span>
<span class="sd">         stop emission immediately</span>
<span class="sd">     * setPower(power_value)</span>
<span class="sd">         change the emitted power</span>
<span class="sd">     * getPower()</span>
<span class="sd">         ask for the current power (seting point, not actual emitted power)</span>
<span class="sd">     * setMode</span>
<span class="sd">         set an operating mode: standby, current control, power control</span>
<span class="sd">         or analog modulation.</span>
<span class="sd">     * getMode</span>
<span class="sd">         determine current operating mode</span>
<span class="sd">     * setAutostart</span>
<span class="sd">         if set, the laser will start emission on key turn event or on</span>
<span class="sd">         powerup. Otherwise, it can be started only from software with</span>
<span class="sd">         *LOn* command (**start** function).</span>
<span class="sd">     * getAutostart</span>
<span class="sd">         determine if autostart is active</span>


<span class="sd">    Laser control</span>
<span class="sd">    -------------</span>
<span class="sd">    The device itself contains FTDI microchip, which emulates serial port</span>
<span class="sd">    via USB. In Linux it appears as **\dev\ttyUSB#** file, where **#**</span>
<span class="sd">    is a number. In Windows, it leads to appearance of an additional COM</span>
<span class="sd">    port (**COM##**).</span>

<span class="sd">    If the laser is connected via USB cable, the baudrate is 500000; it can</span>
<span class="sd">    also be connected via RS-232 interface with a special cable, then the</span>
<span class="sd">    baudrate should be set to 57600.</span>

<span class="sd">    The laser is controlled with short commands (register matters!). The</span>
<span class="sd">    full desciption of commands can be found in the file</span>
<span class="sd">    *PhoxX_LuxX_BrixX_command_list V1.0.pdf*. Here is a list of commands</span>
<span class="sd">    that are relevant to the LuxX model:</span>
<span class="sd">     * RsC</span>
<span class="sd">         Reset Controller</span>
<span class="sd">     * GFw</span>
<span class="sd">         Get Firmware</span>
<span class="sd">     * GSN</span>
<span class="sd">         Get Serial Number</span>
<span class="sd">     * GSI</span>
<span class="sd">         Get Spec Info</span>
<span class="sd">     * GMP</span>
<span class="sd">         Get Maximum Power</span>
<span class="sd">     * GWH</span>
<span class="sd">         Get Working Hours</span>
<span class="sd">     * ROM</span>
<span class="sd">         Recall Operating Mode (Standby, CW-ACC, CW-APC, Analog)</span>
<span class="sd">     * GOM</span>
<span class="sd">         Get Operating Mode (**ASCII HEX**)</span>
<span class="sd">     * SOM</span>
<span class="sd">         Set Operating Mode (**ASCII HEX**)</span>
<span class="sd">     * SAS</span>
<span class="sd">         Set Auto Start (Laser will emit after startup)</span>
<span class="sd">     * SAP</span>
<span class="sd">         Set Auto Powerup</span>
<span class="sd">     * LOn</span>
<span class="sd">         Laser On - start emission</span>
<span class="sd">     * LOf</span>
<span class="sd">         Laser Off</span>
<span class="sd">     * POn</span>
<span class="sd">         Power On</span>
<span class="sd">     * POf</span>
<span class="sd">         Power Off</span>
<span class="sd">     * GAS</span>
<span class="sd">         Get Actual Status</span>
<span class="sd">     * GFB</span>
<span class="sd">         Get Failure Byte (**ASCII HEX**)</span>
<span class="sd">     * GLF</span>
<span class="sd">         Get Last Failurebyte (**ASCII HEX**)</span>
<span class="sd">     * MDP</span>
<span class="sd">         Measure Diode Power</span>
<span class="sd">     * MTD</span>
<span class="sd">         Measure Temperature Diode</span>
<span class="sd">     * MTA</span>
<span class="sd">         Measure Temperature Ambient</span>
<span class="sd">     * CLD</span>
<span class="sd">         Calibrate Laser Diode</span>
<span class="sd">     * SLP</span>
<span class="sd">         Set Level Power - set the emitted power (**ASCII HEX up to 0xFFF**)</span>
<span class="sd">     * GLP</span>
<span class="sd">         Get Level Power (**ASCII HEX**)</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">500000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open port (*auto* stands for **/dev/ttyUSB0** in Linux or **COM17**</span>
<span class="sd">        in Windows, because it is what I use); then get device model;</span>
<span class="sd">        finally, get maximum output power and store it in **pmax** variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">port</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;win&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># for computer in the lab</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="s2">&quot;COM17&quot;</span>
                <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;linux&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="s2">&quot;/dev/ttyUSB0&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sorry, unsupported operating system: &#39;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">baudrate</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">firmware</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;GFw&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">firmware</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;LuxX&quot;</span><span class="p">)</span>  <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">firmware</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;BrixX&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">firmware</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;PhoxX&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The LuxX | BrixX | PhoxX laser is not connected. &quot;</span> <span class="o">+</span> \
                      <span class="s2">&quot;The received answer for &#39;?GFw</span><span class="se">\\</span><span class="s2">r&#39; command is:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
                      <span class="bp">self</span><span class="o">.</span><span class="n">firmware</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span>
            <span class="c1"># From this point we know, that the right laser is connected</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wavelength</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;GSI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;GSN&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;GWH&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pmax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;GMP&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">laser_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">firmware</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelength</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">laser_name</span><span class="p">)</span>
            <span class="c1">#self.laser_name_mine = # give some more desriptive names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_parameters_mine</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_errors_mine</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_status_mine</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Port &quot;</span><span class="si">%s</span><span class="s1">&quot; is unavailable.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">port</span> <span class="o">+</span> \
                          <span class="s1">&#39;May be the laser is not connected, the wrong&#39;</span> <span class="o">+</span> \
                          <span class="s1">&#39; port is specified or the port is already opened&#39;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the port before exit.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Port closed&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;could not close the port&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">laser_name</span><span class="si">}</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="Laser.write">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.Laser.write">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send *command* to device. Preceed it with &quot;?&quot; und end with CR.&quot;&quot;&quot;</span>
        <span class="c1">#self.port.write(&quot;?&quot; + command + &quot;\r&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;?</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="se">\r</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="Laser.read">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.Laser.read">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read all information from the port and return it as string.&quot;&quot;&quot;</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="o">.</span><span class="n">readall</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="n">answer</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xa7</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot; | &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;got some weird unicode characters</span><span class="si">{</span><span class="n">answer</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">answer</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="Laser.ask">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.Laser.ask">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write, then read. However, return only the relevant info.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>  <span class="c1"># happens sometimes if serial was closed</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;GFw&quot;</span><span class="p">:</span>  <span class="c1">#happens if not a laser</span>
            <span class="k">raise</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;!UK</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command &#39;</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&#39; is unknown for this device&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;!</span><span class="si">{</span><span class="n">command</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">(.+)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Laser responded with error to command &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span></div>



<div class="viewcode-block" id="Laser.smart_ask">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.Laser.smart_ask">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">smart_ask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Several commands return information coded in ASCII HEX numbers.</span>
<span class="sd">        The relevant are bits in the registers. For convenient</span>
<span class="sd">        representation, we will print these bytes in tables.</span>
<span class="sd">        This is relevant for the following commands:</span>
<span class="sd">            * GOM</span>
<span class="sd">            * GFB</span>
<span class="sd">            * GLF</span>
<span class="sd">            * GLP</span>
<span class="sd">        For all other commands the behavior is identical to **ask** function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GOM&quot;</span><span class="p">,</span> <span class="s2">&quot;GFB&quot;</span><span class="p">,</span> <span class="s2">&quot;GLF&quot;</span><span class="p">,</span> <span class="s2">&quot;GLP&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">print_hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="n">command</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">turn_power_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;POn&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;power on&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">turn_power_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;POf&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;power off&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="Laser.start">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.Laser.start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the emission (takes about 3 seconds)&quot;&quot;&quot;</span>
        <span class="c1">#self.write(&quot;LOn&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Laser on&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;LOn&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt; ok</span>
<span class="sd">        x error</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Laser.stop">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.Laser.stop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop the emission immediately&quot;&quot;&quot;</span>
        <span class="c1">#self.write(&quot;LOf&quot;)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;LOf&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Laser off&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span></div>



<div class="viewcode-block" id="Laser.set_power">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.Laser.set_power">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">power</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the desired power in mW&quot;&quot;&quot;</span>
        <span class="c1"># Calculate the corresponding HEX code and transmit it</span>
        <span class="k">if</span> <span class="n">power</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmax</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Laser provides %imW only. The maximum power is set </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pmax</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;SLPFFF&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">4095</span><span class="o">*</span><span class="n">power</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">pmax</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;SLP</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span></div>



<div class="viewcode-block" id="Laser.get_power">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.Laser.get_power">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_power</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current power value in mW&quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;GLP&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pmax</span><span class="o">/</span><span class="mf">4095.</span></div>



<div class="viewcode-block" id="Laser.set_mode">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.Laser.set_mode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The device is able to work in the following modes:</span>
<span class="sd">          * Standby</span>
<span class="sd">              Laser is ready, but no emission is produced. However, if we</span>
<span class="sd">              it is turned on (e.g. with **start** function), then change to</span>
<span class="sd">              other mode will result in immediate emission, i.e. without</span>
<span class="sd">              3 seconds delay.</span>
<span class="sd">          * CW-ACC</span>
<span class="sd">              constant wave, automatic current control</span>
<span class="sd">          * CW-APC</span>
<span class="sd">              constant wave, automatic power control</span>
<span class="sd">          * Analog</span>
<span class="sd">              the output power is dependent on the analog input; however,</span>
<span class="sd">              it cannot exceed the specified with **set_power** value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;Standby&quot;</span> <span class="ow">or</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;CW-ACC&quot;</span> <span class="ow">or</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;CW-APC&quot;</span> <span class="ow">or</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;Analog&quot;</span> <span class="ow">or</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;Analog+Digital&quot;</span> <span class="ow">or</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;**mode** must be one of &#39;Standby&#39;, &#39;CW-ACC&#39;, &quot;</span> <span class="o">+</span> \
                        <span class="s2">&quot;&#39;CW-APC&#39;, &#39;Analog&#39; &#39;Analog+Digital&#39;, or number 0-4. Nothing changed.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;ROM</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mode</span><span class="p">)</span></div>



<div class="viewcode-block" id="Laser.get_mode">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.Laser.get_mode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The device is able to work in the following modes:</span>
<span class="sd">          * Standby</span>
<span class="sd">              turned off</span>
<span class="sd">          * CW-ACC</span>
<span class="sd">              constant wave, automatic current control</span>
<span class="sd">          * CW-APC</span>
<span class="sd">              constant wave, automatic power control</span>
<span class="sd">          * Analog</span>
<span class="sd">              the output power is dependent on the analog input; however,</span>
<span class="sd">              it cannot exceed the specified with **set_power** value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;ROM&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Standby&quot;</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;CW-ACC&quot;</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;CW-APC&quot;</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Analog&quot;</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Analog+Digital&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mode</span></div>



<div class="viewcode-block" id="Laser.set_autostart">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.Laser.set_autostart">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_autostart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decide if light is emitted on powerup.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;SAS1&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;SAS0&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="Laser.get_autostart">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.Laser.get_autostart">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_autostart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if light is emitted on powerup.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;SAS&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Laser.get_emitted_power">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.Laser.get_emitted_power">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_emitted_power</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get current power measured by internal diode</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s1">&#39;MDP&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="Laser.get_parameters">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.Laser.get_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print a table showing laser status.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smart_ask</span><span class="p">(</span><span class="s2">&quot;GOM&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Bit description:</span>
<span class="s2">        15  Auto PowerUP if ONE</span>
<span class="s2">        14  Autostart (emission at powerup) if ONE</span>
<span class="s2">        13  Adhoc USB - Laser sends info messages from time to time if ONE</span>
<span class="s2">        8   Power control (APC) mode if ONE; current control (ACC) if ZERO</span>
<span class="s2">        7   External analog input enabled if ONE</span>
<span class="s2">        4   Mod level: ONE - active; ZERO - not active</span>
<span class="s2">        3   Bias level: ONE - active; ZERO - not active</span>

<span class="s2">        Bits 0, 1, 2, 5, 6, 9, 10, 11, 12 are reserved</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_status_mine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;GAS&quot;</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">16</span>  <span class="c1">## equals to hexadecimal</span>
        <span class="n">num_of_bits</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bit_representation</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">scale</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">num_of_bits</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">bit_representation</span> <span class="o">=</span> <span class="n">bit_representation</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;interlock&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">bit_representation</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;on state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">bit_representation</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;preheat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">bit_representation</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;laser_enable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">bit_representation</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="k">else</span> <span class="kc">False</span> <span class="c1"># this is</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">bit_representation</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;powered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">bit_representation</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> <span class="k">else</span> <span class="kc">False</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_parameters_mine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;GOM&quot;</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">16</span>  <span class="c1">## equals to hexadecimal</span>
        <span class="n">num_of_bits</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="n">bit_representation</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">scale</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">num_of_bits</span><span class="p">)</span>
        <span class="n">bit_representation</span> <span class="o">=</span> <span class="n">bit_representation</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;AutoPowerup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">bit_representation</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Autostart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">bit_representation</span><span class="p">[</span><span class="mi">14</span><span class="p">])</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Adhoc USB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">bit_representation</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Power control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;APC&quot;</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">bit_representation</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span> <span class="k">else</span> <span class="s2">&quot;ACC&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;External analog&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">bit_representation</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ext TTL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">bit_representation</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Mod level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">bit_representation</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Bias level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">bit_representation</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">else</span> <span class="kc">False</span>


<div class="viewcode-block" id="Laser.get_errors">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.Laser.get_errors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print contents of failure byte&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smart_ask</span><span class="p">(</span><span class="s2">&quot;GFB&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Bit description:</span>
<span class="s2">        15  Diode power exceeded maximum value</span>
<span class="s2">        14  An internal error occured</span>
<span class="s2">        12  The temperature at the diode exceeded the valid temperature range</span>
<span class="s2">        11  The ambient temperature exceeded the minimum or maximum value</span>
<span class="s2">        10  The current through the diode exceeded the maximum allowed value</span>
<span class="s2">        9   The interlock loop is not closed. Please close the interlockt loop</span>
<span class="s2">        8   Overvoltage or Undervoltage lockout occured. Bring supply voltage to a valid range</span>
<span class="s2">        4   If CDRH-Bit is set and no CDRH-Kit is connected or</span>
<span class="s2">            CDRH-Bit is not set but a CDRH-Kit is connected</span>
<span class="s2">            CDRH-Kit is a box with a key, a LED and an interlock</span>
<span class="s2">        0   Soft interlock: If an interlock error occurs, this bit is set. It can only be</span>
<span class="s2">            reset by resetting the whole system, even if the interlock error is</span>
<span class="s2">            not present anymore.</span>

<span class="s2">        Bits 1, 2, 3, 5, 6, 7, 13 are reserved</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_errors_mine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;GFB&quot;</span><span class="p">)</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">check_errors</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">laser_name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">LaserErrors</span><span class="o">.</span><span class="n">no_errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_state</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_state</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">power</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># set to analog mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Analog Mode&#39;</span><span class="p">)</span>
        <span class="c1">#if power == -1:</span>
        <span class="c1">#    power = self.pmax  # #set to max power</span>
        <span class="c1">#self.set_power(power)</span>
        <span class="c1">#self.log.debug(f&#39;Set power to {power}&#39;)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">power_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s1">&#39;POn&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Power On&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># set to analog mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Analog Mode&#39;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">test_apc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s1">&#39;POn&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Power On&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># set to APC mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;APC Mode&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># set to analog mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s1">&#39;POf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Power Off&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_thread</span>  <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_apc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="stopwatch">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.stopwatch">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">stopwatch</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">func_args</span><span class="p">,</span> <span class="o">**</span><span class="n">func_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Call **func** and print elapsed time&quot;&quot;&quot;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">func_args</span><span class="p">,</span> <span class="o">**</span><span class="n">func_kwargs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time elapsed: </span><span class="si">%5.2f</span><span class="s2"> ms&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">*</span><span class="mf">1000.0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">check_errors</span><span class="p">(</span><span class="n">hex_code</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mi">16</span>  <span class="c1">## equals to hexadecimal</span>
    <span class="n">num_of_bits</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">bit_representation</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hex_code</span><span class="p">,</span> <span class="n">scale</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">num_of_bits</span><span class="p">)</span>
    <span class="n">bit_representation</span> <span class="o">=</span> <span class="n">bit_representation</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">on_bits</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">bit_representation</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">on_bits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">LaserErrors</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">LaserErrors</span><span class="p">(</span><span class="n">on_bit</span><span class="p">)</span> <span class="k">for</span> <span class="n">on_bit</span> <span class="ow">in</span> <span class="n">on_bits</span><span class="p">]</span>




<div class="viewcode-block" id="print_hex">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.print_hex">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">print_hex</span><span class="p">(</span><span class="n">hex_code</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print a nice table that represents *hex_code* (ASCII HEX string)</span>
<span class="sd">    in a binary code.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    corresponding decimal numbers in array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If the number is odd, pad it with leading zero</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;got hex code </span><span class="si">{</span><span class="n">hex_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hex_code</span><span class="p">)</span>
    <span class="n">byte_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span> <span class="o">%</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">hex_code</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="n">hex_code</span>

    <span class="c1"># Split it into 8-bit numbers coded in ASCII HEX</span>
    <span class="n">hex_numbers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">byte_number</span><span class="p">):</span>
        <span class="n">hex_numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hex_code</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span> <span class="p">:</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># Convert each of them into decimal</span>
    <span class="n">decimals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">hex_number</span> <span class="ow">in</span> <span class="n">hex_numbers</span><span class="p">:</span>
        <span class="n">decimals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hex_number</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

    <span class="c1"># Print a table</span>
    <span class="n">table</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;BYTE ##  :  &#39;?&#39;</span>
<span class="s2">    | ## | ## | ## | ## | ## | ## | ## | ## |</span>
<span class="s2">    |----|----|----|----|----|----|----|----|</span>
<span class="s2">    |  ? |  ? |  ? |  ? |  ? |  ? |  ? |  ? |</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;##&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%2i</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Representation of ASCII HEX &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">hex_code</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">number</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">decimals</span><span class="p">):</span>
        <span class="n">byte</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">decimals</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">content</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">byte</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="n">byte</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="mi">8</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
                                          <span class="nb">list</span><span class="p">(</span><span class="nb">bin</span><span class="p">(</span><span class="n">number</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">table</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">byte</span><span class="p">,</span> <span class="n">hex_numbers</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="n">content</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">decimals</span></div>


<div class="viewcode-block" id="LaserErrors">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.LaserErrors">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LaserErrors</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">no_errors</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;No errors&quot;</span><span class="p">)</span>
    <span class="n">soft_inter</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Soft interlock: If an interlock error occurs, this bit is set. It can only be reset by resetting &quot;</span>
                     <span class="s2">&quot;the whole system, even if the interlock error is not present anymore.&quot;</span><span class="p">)</span>
    <span class="n">max_power</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;Diode power exceeded maximum value&quot;</span><span class="p">)</span>
    <span class="n">int_error</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span>  <span class="s2">&quot;An internal error occured&quot;</span><span class="p">)</span>
    <span class="n">temp_error</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;The temperature at the diode exceeded the valid temperature range&quot;</span><span class="p">)</span>
    <span class="n">atemp_error</span> <span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span>  <span class="s2">&quot;The ambient temperature exceeded the minimum or maximum value&quot;</span><span class="p">)</span>
    <span class="n">curr_error</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span>  <span class="s2">&quot;The current through the diode exceeded the maximum allowed value&quot;</span><span class="p">)</span>
    <span class="n">interloop_error</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span>  <span class="s2">&quot;The interlock loop is not closed. Please close the interlockt loop&quot;</span><span class="p">)</span>
    <span class="n">voltage_error</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span>   <span class="s2">&quot;Overvoltage or Undervoltage lockout occured. Bring supply voltage to a valid range&quot;</span><span class="p">)</span>
    <span class="n">bit_error</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;If CDRH-Bit is set and no CDRH-Kit is connected or CDRH-Bit is not set but a CDRH-Kit is connected&quot;</span>
                    <span class="s2">&quot; CDRH-Kit is a box with a key, a LED and an interlock&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">alias</span><span class="p">):</span>
        <span class="n">member</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">member</span><span class="o">.</span><span class="n">_value_</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">member</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">alias</span>
        <span class="k">return</span> <span class="n">member</span></div>



<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt6</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtSerialPort</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">serial.tools.list_ports</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LaserModule</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lasers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;LaserModule&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">serial</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">list_ports</span><span class="o">.</span><span class="n">comports</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;/dev/ttyUSB&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">port</span><span class="o">.</span><span class="n">device</span> <span class="ow">or</span> <span class="s2">&quot;LuxX&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">port</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>  <span class="c1"># usually lasers called like this #skip arduino connected as USB0, find a way to identify?</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pot_laser</span> <span class="o">=</span> <span class="n">Laser</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="c1"># try to connect to laser</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">pot_laser</span><span class="o">.</span><span class="n">laser_name</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">port</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">pot_laser</span><span class="o">.</span><span class="n">wavelength</span><span class="si">}</span><span class="s2">nm wavelength and </span><span class="si">{</span><span class="n">pot_laser</span><span class="o">.</span><span class="n">pmax</span><span class="si">}</span><span class="s2">mW max power&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pot_laser</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">port</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s1"> is not a valid laser&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lasers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not find any lasers!&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the port before exit.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">laser</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
                <span class="n">laser</span><span class="o">.</span><span class="n">port</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Port closed&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;could not close the port&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">turn_off_lasers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">laser</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
            <span class="n">laser</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">laser</span><span class="o">.</span><span class="n">turn_power_off</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">turn_on_lasers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec_lasers</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">laser</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">laser</span><span class="o">.</span><span class="n">wavelength</span> <span class="ow">in</span> <span class="n">spec_lasers</span><span class="p">:</span>
                <span class="c1"># TODO think about power ? !</span>
                <span class="n">laser</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>

                <span class="c1">#set to standby</span>
                <span class="c1">#set to correct mode</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_lasers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting lasers&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">laser</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">laser</span><span class="o">.</span><span class="n">wavelength</span> <span class="ow">in</span> <span class="n">wavelengths</span><span class="p">:</span>
                <span class="n">laser</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">powerup_lasers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Poweringup lasers&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">laser</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">laser</span><span class="o">.</span><span class="n">wavelength</span> <span class="ow">in</span> <span class="n">wavelengths</span><span class="p">:</span>
                <span class="n">laser</span><span class="o">.</span><span class="n">power_up</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">put_lasers_standby</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Setting lasers in standby&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">laser</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
            <span class="n">laser</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">laser</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_lasers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Testing lasers&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">laser</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">laser</span><span class="o">.</span><span class="n">wavelength</span> <span class="ow">in</span> <span class="n">wavelengths</span><span class="p">:</span>
                <span class="n">laser</span><span class="o">.</span><span class="n">start_test</span><span class="p">()</span>


<div class="viewcode-block" id="LaserColor">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.LaserColor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LaserColor</span> <span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">405</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mi">473</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mi">560</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">594</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">647</span></div>


<div class="viewcode-block" id="TriggerEnum">
<a class="viewcode-back" href="../../api.html#FreiCtrl_laser.luxx_communication.TriggerEnum">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TriggerEnum</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">IntTrigger</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ExtTrigger0</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ExtTrigger1</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">ExtTrigger2</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">ExtTrigger3</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">IntTrigger2</span> <span class="o">=</span> <span class="mi">5</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">las_module</span> <span class="o">=</span> <span class="n">LaserModule</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">)</span>

<span class="c1"># to trigger a laser</span>
<span class="c1"># power up (auto)</span>
<span class="c1"># set to mode 4</span>
<span class="c1"># start the laser</span>
<span class="c1"># trigger</span>

<span class="c1"># do a gui ? user a queu to send commands ? or asynch processing to not send commands while waiting for response ?</span>





</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">FreiCtrl_laser 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">FreiCtrl_laser.luxx_communication</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Artur Schneider (Optophysiology, University Freiburg).
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>